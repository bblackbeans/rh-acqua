{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:email_system_dashboard' %}">Sistema de Email</a>
    &rsaquo; Dashboard
</div>
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2c5aa0;
        }
        .stat-card.pending .number { color: #ffc107; }
        .stat-card.sent .number { color: #28a745; }
        .stat-card.failed .number { color: #dc3545; }
        .stat-card.info .number { color: #17a2b8; }
        
        .recent-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .recent-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        .recent-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #2c5aa0;
            padding-bottom: 10px;
        }
        .recent-table {
            width: 100%;
            border-collapse: collapse;
        }
        .recent-table th,
        .recent-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .recent-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-sent { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #2c5aa0;
            padding-bottom: 10px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #2c5aa0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #1e3a5f;
        }
    </style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>üìß Dashboard - Sistema de Email</h1>
    
    <!-- Estat√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total de Emails</h3>
            <div class="number">{{ stats.total_emails }}</div>
        </div>
        <div class="stat-card pending">
            <h3>Emails Pendentes</h3>
            <div class="number">{{ stats.pending_emails }}</div>
        </div>
        <div class="stat-card sent">
            <h3>Emails Enviados</h3>
            <div class="number">{{ stats.sent_emails }}</div>
        </div>
        <div class="stat-card failed">
            <h3>Emails com Falha</h3>
            <div class="number">{{ stats.failed_emails }}</div>
        </div>
        <div class="stat-card info">
            <h3>Configura√ß√µes SMTP</h3>
            <div class="number">{{ stats.smtp_configs }}</div>
        </div>
        <div class="stat-card info">
            <h3>Gatilhos Ativos</h3>
            <div class="number">{{ stats.active_triggers }}</div>
        </div>
    </div>
    
    <!-- Se√ß√µes Recentes -->
    <div class="recent-section">
        <div class="recent-card">
            <h3>üìã Emails Recentes</h3>
            {% if recent_emails %}
                <table class="recent-table">
                    <thead>
                        <tr>
                            <th>Destinat√°rio</th>
                            <th>Assunto</th>
                            <th>Status</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for email in recent_emails %}
                        <tr>
                            <td>{{ email.to_email }}</td>
                            <td>{{ email.subject|truncatechars:30 }}</td>
                            <td>
                                <span class="status-badge status-{{ email.status }}">
                                    {{ email.get_status_display }}
                                </span>
                            </td>
                            <td>{{ email.created_at|date:"d/m H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Nenhum email encontrado.</p>
            {% endif %}
        </div>
        
        <div class="recent-card">
            <h3>üìù Logs Recentes</h3>
            {% if recent_logs %}
                <table class="recent-table">
                    <thead>
                        <tr>
                            <th>Destinat√°rio</th>
                            <th>Status</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_logs %}
                        <tr>
                            <td>{{ log.to_email }}</td>
                            <td>
                                <span class="status-badge status-{{ log.status }}">
                                    {{ log.get_status_display }}
                                </span>
                            </td>
                            <td>{{ log.created_at|date:"d/m H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Nenhum log encontrado.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Teste de Email -->
    <div class="test-section">
        <h3>üß™ Teste de Email</h3>
        <form id="testEmailForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="triggerType">Tipo de Gatilho</label>
                    <select id="triggerType" name="trigger_type">
                        <option value="user_registration">Cadastro de Usu√°rio</option>
                        <option value="application_submitted">Candidatura Realizada</option>
                        <option value="application_approved">Candidatura Aprovada</option>
                        <option value="application_rejected">Candidatura Rejeitada</option>
                        <option value="interview_scheduled">Entrevista Agendada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="toEmail">Email Destinat√°rio</label>
                    <input type="email" id="toEmail" name="to_email" required>
                </div>
                <div class="form-group">
                    <label for="toName">Nome do Destinat√°rio</label>
                    <input type="text" id="toName" name="to_name" value="Usu√°rio Teste">
                </div>
            </div>
            <button type="submit" class="btn">üì§ Enviar Email de Teste</button>
        </form>
    </div>
    
    <!-- Links de Navega√ß√£o -->
    <div style="margin-top: 30px; text-align: center;">
        <a href="{% url 'admin:email_system_queue' %}" class="btn">üìã Fila de Emails</a>
        <a href="{% url 'admin:email_system_logs' %}" class="btn">üìù Logs de Email</a>
        <a href="{% url 'admin:email_system_smtpconfiguration_changelist' %}" class="btn">‚öôÔ∏è Configura√ß√µes SMTP</a>
        <a href="{% url 'admin:email_system_emailtemplate_changelist' %}" class="btn">üìÑ Templates</a>
    </div>
</div>

<script>
document.getElementById('testEmailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        trigger_type: formData.get('trigger_type'),
        to_email: formData.get('to_email'),
        to_name: formData.get('to_name')
    };
    
    fetch('/admin/email-system/api/test-email/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Email de teste adicionado √† fila com sucesso!');
            location.reload();
        } else {
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao enviar email de teste: ' + error);
    });
});
</script>
{% endblock %}
